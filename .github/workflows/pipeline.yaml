name: MLOps Pipeline

on:
  workflow_dispatch:   # allows manual trigger
  push:
    branches:
      - main           # run when changes are pushed to main

jobs:
  sync-colab:
    runs-on: ubuntu-latest
    steps: 
    - uses: actions/checkout@v3
    - name: Install dependencies
      run:  pip install -r mlops/requirements.txt
    - name: Upload Dataset to Hugging Face Hub
      env: 
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: python mlops/mlops/model_building/data_register.py
  
  data prep:
    needs: register-dataset
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Install dependencies
      run:  pip install -r mlops/requirements.txt
    - name: Upload Dataset to Hugging Face Hub
      env: 
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: python mlops/mlops/model_building/prep.py

  model-training:
    needs: data-prep
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Install dependencies
      run:  pip install -r mlops/requirements.txt
    - name: Upload Dataset to Hugging Face Hub
      env: 
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: python mlops/mlops/model_building/train.py
  
  deploy-hosting:
    runs-on: ubuntu-latest
    needs: [model-training, data prep, register-dataset]
    steps:
    - uses: actions/checkout@v3
    - name: Install dependencies
      run:  pip install -r mlops/requirements.txt
    - name: Push files to Frontend Hugging Face Space
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: python mlops/hosting/hosting.py
